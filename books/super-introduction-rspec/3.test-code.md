---
title: "RSpecとテストコードの基本"
---
こちらのChapterでは、イベントで必要になる基本概念を解説していきます。
RSpecの復習として触れていただければと思います。
## RSpecの基本構造
RSpecの場合、以下のブロック構造を使用します。
- `describe`(テスト対象のグループ)
- `context`(テストを行う前提条件)
- `it`(テスト内容)

基本的には`describe`→`context`→`it`という入れ子構造になります。
まずは今回解説するコードの全体像を見ていただき、describe〜itまでの使い分けを解説していきます。
```ruby:models/book_spec.rb
RSpec.describe Book, type: :model do
# Bookモデルのテストをグループ化
  describe "Book#title_with_author" do
  # 書籍のタイトルに関連するテストをグループ化
    context "Book#titleが文字列のとき" do
    # 状況・条件を説明する(正常系)
      it "titleとauthorを結んだ文字列が返ること" do
      # テスト内容
        book = Book.new(title: "RubyBook", author: "matz")
        expect(book.title_with_author).to eq("RubyBook - matz")
      end
    end
    context "Book#titleが空のとき" do
    # 状況・条件を説明する(異常系)
      it "bookを新規登録した際、バリデーションエラーを返すこと" do
      # テスト内容
        book = Book.new(title: "", author: "matz")
        expect(book).to be_invalid
        expect(book.errors[:title]).to eq["can`t be blank"]
      end
    end
  end
end
```
### describe
`describe`はテストの対象をグループ化して整理する役割を担います。
グループ化をして整理することで、**テストの目的や構造**が明確になります。

主に**機能**、**クラス**、**メソッド**に対してグループ化を実施するのが基本です。
基本的に**メソッド**は**クラス**グループ内にネストして記述します。
```ruby:例文(book_spec.rb)
RSpec.describe "Book", type: :model do
# グループ名が"Book"、typeに"model"とすることで、Bookクラスのモデルスペックテストとしてグループ化する
  describe "Book#title_with_author" do
  # Bookクラス内のtitle_with_authorメソッドのテストをグループ化
```

### context
`context`はテストをする前の**前提条件**を記述します。
前提条件は大きく分けて**正常系**と**異常系**で構成していきます。
#### 正常系
ユーザーがアプリに対して正しい操作をした場合、アプリが正常に処理するかどうかをテストします。
例文
```ruby:正常系 book_model.rb
context "Book#titleが文字列のとき" do
  it 〜〜〜
```
上記のコードは"Bookモデルのインスタンスに格納された値が文字列"という想定通りの挙動を前提としているので、**正常系**の前提条件となります。
#### 異常系
ユーザーがアプリに対して間違った操作をした場合、アプリが異常に対して適切に対処出来るかどうかをテストします。
今回イベントで使用するプロジェクトには定義していませんが、Bookモデルに`validates :title, presence: true`(`:title`の**nil**を許容しない)を設定している前提で説明します。

例文
```ruby:異常系 book_model.rb
context "Book#titleがnilのとき" do
  it 〜〜〜
```
本来Bookモデルインスタンスのtitleに文字列が格納されているはずなのに、nil(値が存在しない)が定義されています。
この場合"Bookモデルのインスタンスに格納された値がnil"というエラーが発生する挙動を前提としているので、**異常系**の前提条件となります。
### it
`it`はテストの内容を記述します。`describe`と`context`はテスト範囲をグループ化していく役割を担いましたが、`it`は実際にテストコードを書いていくことになります。

下記のコードの場合`it`の数だけテストを実行するので、2回分テストが実行されます。
例文
```ruby:book_model.rb
context "Book#titleが文字列のとき" do
  it "titleとauthorを結んだ文字列が戻ること" do
    book = Book.new(title: "RubyBook", author: "matz")
    expect(book.title_with_author).to eq("RubyBook - matz")
context "Book#titleがnilのとき" do
  it "bookを新規登録した際、バリデーションエラーを返すこと" do
    book = Book.new(title: "", author: "matz")
    expect(book).to be_invalid
    expect(book.errors[:title]).to eq["can`t be blank"]
```
先ほど定義した**正常系**と**異常系**のグループに、それぞれテスト内容を書いていることがわかります。
テスト内容の書き方(**expect**,**マッチャー**)については後ほど解説いたします。

他にも`example`や`specify`などのエイリアスが存在していますが、テスト上の処理はほとんど同じになりますので、今回のイベントでは`it`のみを使用します。
エイリアスの使い分けについて気になる方は、以下の記事などを参考にしながら各々調べてみてください！
[RSpecでit / example / specifyはどのように使い分けるのか？〜日本語で書くならexampleって本当？〜](https://qiita.com/jnchito/items/8766405c06690cfcb32b)
- - -

## expect(検証用メソッド)
テストが要件に通るか検証するためのメソッドになります。
基本的に`expect(実行処理内容).to マッチャ`という文法で使用されます。まず`expect`メソッドの引数に実行する処理を記述(値やメソッドなど)し、指定した**期待値**と比べることで実際の挙動が要件通りなのかどうかを判定します。
期待値と実際の値を比較には後述する**マッチャー**を使います。

## マッチャー
マッチャーとは先程お話した通り、期待値と実際の値を**比較**した結果を出力するために使われるオブジェクトになります。
文章で書いていても分かりづらいと思うので、上記に書いたモデルスペックを例に**正常系**と**異常系**をそれぞれ解説します。
### 正常系
```ruby:models/book_spec.rb
〜〜
it "titleとauthorを結んだ文字列が返ること" do
  # Bookモデルのインスタンスを作成
  book = Book.new(title: "RubyBook", author: "matz")
  # Bookモデルのtitle_with_authorを対象。eqで完全一致しているかチェック
  expect(book.title_with_author).to eq("RubyBook - matz")
〜〜
```
まず`book`に**title**、**author**の値を代入したBookモデルのインスタンスを格納します。
次に`expect`メソッドの引数に、Bookモデル内で定義している**title_with_author**メソッドを呼び出しています。
```ruby:models/book.rb
class Book < ApplicationRecord
  def title_with_author
    "#{title} - #{author}"
  end
end
```
今回のメソッドは**本のタイトル**と**著者名**を "-"(ハイフン)で繋げる内容になります。
なので`title_with_author`メソッドの返り値は"**RubyBook - matz**"と出力されます。

そしていよいよマッチャーが使われます。マッチャーは**to**の後ろに記述されるので、今回のテストコードのマッチャーは`eq(期待値)`です。
`eq(期待値)`は実際の値と期待値が**完全一致**しているか比較するマッチャーになります。なので

実際の値 = "RubyBook - matz"
期待値　 = "RubyBook - matz"

今回の場合、どちらの値も**完全一致**している事が確認できました。テストは成功となります。
### 異常系
```ruby:models/book_spec.rb
〜〜
it "bookを新規登録した際、バリデーションエラーを返すこと" do
  # Bookモデルのインスタンスを作成。この時異常を検出するため、titleを空に設定
  book = Book.new(title: "", author: "matz")
  # Bookモデルのインスタンスを対象。be_invalidでバリデーションエラーが動作するかチェック
  expect(book).to be_invalid
  # 今度はbookモデルインスタンスのerrors[:title]を対象。
  # :titleのエラーメッセージに"can`t be blank"が格納されているかチェック
  expect(book.errors[:title]).to eq["can`t be blank"]
〜〜
```
異常系テストの場合、事前に間違った値を準備しておく必要があります。
今回は`:titleが空`というbookインスタンスを作成しましょう。

そして今回は2つの検証を実施したいので、マッチャーも２つ使用していきます。`be_invalid`と`eq(期待値)`です。
1回目の検証で使用する`be_invalid`は、指定したオブジェクトのバリデーションが**無効**(バリデーションエラー)になるか判定するマッチャーです。逆に有効になってデータが登録されてしまうと、テストは失敗してしまいます。
そして`be_invalid`は無事にバリデーションエラーになると、対象の属性に**エラーメッセージ**が付与されます。こちらは次の検証において使用していきます。

2回目の検証では、先程作成されたエラーメッセージの内容が想定通りかどうかテストします。
エラー検証(expect)の引数に`book.errors[:title]`と指定すると、errorオブジェクトの:title属性をテスト対象にすることが出来ます。
今回は**titleは空白には出来ない**という条件なので、`eq[]`マッチャーを使用し"can`t be blank"という文字列が格納されているかチェックします。値が**完全一致**している場合、2つの検証が成立し、テストは成功となります。

マッチャーは様々な種類が存在しているので、条件に合わせて各々調べてみましょう！
[RSpec公式ドキュメント マッチャー一覧](https://rspec.info/features/3-12/rspec-expectations/built-in-matchers/)
[Module: RSpec::Matchers](https://www.rubydoc.info/gems/rspec-expectations/RSpec/Matchers)
[RSpecでよく使うmatcherの種類](https://qiita.com/Hashimoto-Noriaki/items/bafbdac8e6a2fe1fd8b1)